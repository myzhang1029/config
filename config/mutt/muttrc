set editor=vim
set pipe_decode=yes
set my_pw=`sq decrypt ~/.config/mutt/$MAIL_USER.gpg`
set imap_user=`echo $MAIL_USER`
set imap_pass=$my_pw
set smtp_pass=$my_pw
set folder=imaps://mail.maiyun.me/
set spoolfile=+INBOX
set record=+Sent
set edit_headers=yes
set smtp_url=smtp://$imap_user@mail.maiyun.me/
set ssl_force_tls=yes
set ssl_starttls=yes
set reverse_name=yes
set from=`echo $MAIL_USER@maiyun.me`
set message_id_format = "<%Y%02m%02d%x%x%x%x%x%x@localnet.as211585.net>"
alternates `cat ~/.config/mutt/$MAIL_USER.alts.txt`

# Sidebar
set sidebar_visible = yes
set sidebar_width = 10
color sidebar_new yellow default
bind index,pager <Esc>k sidebar-prev
bind index,pager <Esc>j sidebar-next
bind index,pager <Esc>o sidebar-open
bind index,pager <Esc>u sidebar-page-up
bind index,pager <Esc>d sidebar-page-down
mailboxes -label "Inbox" "+INBOX"
mailboxes -label "Archive" "+Archive"
mailboxes -label "Sent" "+Sent"

# PGP Stuff
set crypt_use_gpgme=no
set crypt_autosign=yes
set crypt_replysign=yes
set crypt_replysignencrypted=yes
set crypt_replyencrypt=yes
set pgp_sign_as=3F1AB0279EA3843F

# OpenPGP support using Sequoia-PGP. Based on <https://wiki.debian.org/OpenPGP/Sequoia#Integration>
set crypt_use_gpgme=no
set pgp_timeout=3600

# Encryption and signing
# TODO: This relies on gpg-sq, as upstream does not distinguish between
# verifying cleartext, decrypting messages and analyzing public keys, for
# application/pgp types.
set pgp_decode_command="gpg-sq --status-fd=2 %?p?--passphrase-fd 0 --pinentry-mode=loopback? --no-verbose --quiet --batch --output - %f"
set pgp_verify_command="sq verify --signature-file %s -- %f"
set pgp_sign_command="sq sign --batch %?a?--signer %a? --mode text --signature-file - -- %f"
set pgp_clearsign_command="sq sign --batch %?a?--signer %a? --cleartext -- %f"
set pgp_decrypt_command="sq decrypt --batch --signatures 0 -- %f"
# Note: We use pgpewrap because %r is a list, and --for only handles one
# argument per option.
set pgp_encrypt_only_command="pgpewrap sq encrypt --batch --for-self -- --for %r -- %f"
set pgp_encrypt_sign_command="pgpewrap sq encrypt --batch %?a?--signer %a? --for-self -- --for %r -- %f"

# Keyring management
set pgp_import_command="sq cert import -- %f"
set pgp_export_command="sq cert export --cert %r"
# Note: Disabled by default as the search can take some time.
#set pgp_getkeys_command="sq network search --batch --quiet -- %r"
set pgp_verify_key_command="sq pki identify --cert %r 2>&1"
# TODO: This relies on gpg-sq, ideally this would use a native interface.
# Note: the second --with-fingerprint adds fingerprints to subkeys
set pgp_list_pubring_command="gpg-sq --no-verbose --batch --quiet --with-colons --with-fingerprint --with-fingerprint --list-keys %r"
set pgp_list_secring_command="gpg-sq --no-verbose --batch --quiet --with-colons --with-fingerprint --with-fingerprint --list-secret-keys %r"

set pgp_good_sign="^[[:space:]]*Good signature from "
set pgp_decryption_okay="^[[:space:]]*Encrypted using "
# TODO: Does mutt handle non-zero error codes correctly?
set pgp_check_exit=yes
unset pgp_check_gpg_decrypt_status_fd
